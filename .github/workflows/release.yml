name: Release Build

on:
  push:
    tags:
      - 'v*'

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libpipewire-0.3-dev \
            pipewire \
            wireplumber \
            libasound2-dev \
            libpulse-dev

      - name: Install Frontend Dependencies
        run: npm install

      - name: Build Frontend
        run: npm run build

      - name: Build Tauri App
        run: npm run tauri build

      - name: Rename Artifacts
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          cd src-tauri/target/release/bundle

          # AppImage umbenennen
          if [ -f appimage/inox-mix_${VERSION}_amd64.AppImage ]; then
            mv appimage/inox-mix_${VERSION}_amd64.AppImage appimage/inox-mix-${VERSION}-x86_64.AppImage
          fi

          # .deb umbenennen
          if [ -f deb/inox-mix_${VERSION}_amd64.deb ]; then
            mv deb/inox-mix_${VERSION}_amd64.deb deb/inox-mix-${VERSION}-amd64.deb
          fi

      - name: Generate Checksums
        run: |
          cd src-tauri/target/release/bundle
          sha256sum appimage/*.AppImage > appimage/checksums.txt
          sha256sum deb/*.deb > deb/checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/appimage/checksums.txt
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/deb/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Update Manifest
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          cat > latest.json << EOF
          {
            "version": "${VERSION}",
            "notes": "See https://github.com/inox-network/inox-mix/releases/tag/${VERSION}",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "linux-x86_64": {
                "signature": "",
                "url": "https://github.com/inox-network/inox-mix/releases/download/${VERSION}/inox-mix-${VERSION#v}-x86_64.AppImage"
              }
            }
          }
          EOF

      - name: Upload Update Manifest
        uses: softprops/action-gh-release@v1
        with:
          files: latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
